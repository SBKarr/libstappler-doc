# Сборочная система

Сборочная система первого уровня основана на Makefile (требует GNU Make не ниже 4.1). Для интеграции со сборочными системами других платформ генерируются дополнительные файлы:

* Android.mk для Android SDK (цель android-export)
* *.xcconfig для XCode (цель ios-export и mac-export)

**Внимание**: На текущий момент протестирована сборка только для Linux, Android, Windows (на основе clang и кросскомпиляция на основе xwin на Linux). Сборка для MacOS/iOS в разработке.

Сборочная система предназначена только для сборки исполняемых файлов и библиотек, и интеграции этого в сборку более высокого уровня, которая будет создавать конечный пакет приложения. Этим обусловлены ограниченные возможности для установки результатов компиляции в систему.

Пример Makefile для проекта:

```make
#путь к рутовой директории фреймворка
STAPPLER_ROOT ?= ../../..

# корневая директория проекта, обычно устанавливается в текущую ( . )
LOCAL_ROOT = .

# директория файлов сборки
LOCAL_OUTDIR := stappler-build

# название исполняемого файла, который будет собран. Если не указано - исполняемый пакет не собирается
LOCAL_EXECUTABLE := test

# список файлов наборов модулей, которые определяют доступные для включения модули
LOCAL_MODULES_PATHS =  $(STAPPLER_ROOT)/core/stappler-modules.mk

# список требуемых модулей
LOCAL_MODULES ?= stappler_data stappler_brotli_lib stappler_filesystem

# список директорий для компиляции
LOCAL_SRCS_DIRS := 

# список отдельных файлов для компиляции
LOCAL_SRCS_OBJS := 

# список директорий для включения (передаётся в -I компилятора)
LOCAL_INCLUDES_DIRS := 

# список отдельных элементов для включения (передаётся в -I компилятора)
LOCAL_INCLUDES_OBJS := 

# файл, содержащий функцию main, игнорируется при сборке библиотек
LOCAL_MAIN := main.cpp 

# список дополнительных статических и динамических библиотек для линковки
LOCAL_LIBS = 

# инициализация универсального сборщика
include $(STAPPLER_ROOT)/build/make/universal.mk
```

# Документация

## Файлы и цели

`$(STAPPLER_ROOT)/build/make/universal.mk` - основной файл для сборки кроссплатформенного проекта.
Предоставляет цели для сборки на платформах android, ios и хоста (Linux, Darwin/MacOS или Windows):

Цели группы `host` - сборка проекта для машин, соотвествующих текущему хосту (Linux, Darwin/MacOS или Windows)
`host-install`: Установить собранный проект (параметры установки должны быть заданы)
`host-debug`: Собирает проект для отладки
`host-debug-clean`: Очищает собранный для отладки проект
`host-release`: Собирает проект для выпуска
`host-release-clean`: Очищает собранный для выпуска проект
`host-coverage`: Собирает проект для оценки покрытия тестами и анализа использования
`host-report`: Подготавливает отчёт о покрытии кода и использовании после запуска проекта
`host-coverage-clean`: Очищает сборку для покрытия и анализа

Цели группы `android` - сборка проекта для Android NDK. Наилучший вариант использования - интеграция экспортируемого Android.mk в сборку целевого проекта Gradle, однако прямая сборка с использованием NDK также возможна. Проект собирается для архитектур по умолчанию в NDK (на момент написания, armv7, arm64, x86, x86_64)
Для сборки с использованием NDK необходимо указать путь к NDK в переменной `ANDROID_NDK_ROOT` или просто `NDK`
**Предупреждение**: в целях очистки очищаются только файлы, привязанные к системме сборки libstappler, интегрированные проекты не затрагиваются

`android-export`: Экспортирует скрипт сборки (`Android.mk`) в сборочную директорию.
`android-debug`: Собирает проект для отладки
`android-debug-clean`: Очищает собранный для отладки проект
`android-release`: Собирает проект для выпуска
`android-release-clean`: Очищает собранный для выпуска проект

Цели группы `ios` - сборка проекта для интеграции его с проектом в XCode. В отличии от Android, сборка для iOS требует использования сборочной системы libstappler для компиляции исходного кода, а не только экспорта данных.
**Предупреждение**: в целях очистки очищаются только файлы, привязанные к системме сборки libstappler, интегрированные проекты не затрагиваются

`ios-export`: Экспортирует информацию о сборке (директории включения, флаги компиляции, используемые библиотеки и фреймворки) в файл export.xcconfig в директории сборки.
`ios-debug`: Собирает проект для отладки
`ios-debug-clean`: Очищает собранный для отладки проект
`ios-release`: Собирает проект для выпуска
`ios-release-clean`: Очищает собранный для выпуска проект

Цели группы `xwin` - кросскомиляция проекта для Windows с помощью проекта XWin и clang.

`xwin-debug`: Собирает проект для отладки
`xwin-debug-clean`: Очищает собранный для отладки проект
`xwin-release`: Собирает проект для выпуска
`xwin-release-clean`: Очищает собранный для выпуска проект

## GLOBAL - затрагивающие сборку в целом

`GLOBAL_CC`: компилятор С (`gcc`)
`GLOBAL_CPP`: комплятор C++ (`g++`)
`GLOBAL_CFLAGS`: флаги для C/C++
`GLOBAL_CPPFLAGS`: флаги только для C++
`GLOBAL_RM`: программа для удаления файлов (`rm -f`)
`GLOBAL_CP`: программа для копирования файлов (`cp -f`)
`GLOBAL_MAKE`: программа make
`GLOBAL_MKDIR`: программа для создания директорий (`mkdir -p`)
`GLOBAL_AR`: программа для создания архива объектного кода (`ar rcs`)

## LOCAL - для текущего проекта

`LOCAL_MAKEFILE`: способ указать обратную зависимость от проекта к Makefile. В таком случае, проект будет требовать полной пересборки при изменении Makefile. Например: `LOCAL_MAKEFILE := $(lastword $(MAKEFILE_LIST))`
`LOCAL_OUTDIR`: директория для хранения результатов сборки
`LOCAL_EXECUTABLE`: имя для исполняемого файла, создаваемого в результате сборки
`LOCAL_LIBRARY`: имя для собитаемой библиотеки (собираются статический и динамический варианты, если это возможно)
`LOCAL_BUILD_SHARED`: [0|1|2|3] - собирать ли динамическую библиотеку, по умолчанию 1. При значении 2 игнорируются неудовлетворённые зависимости, при 3 не сливаются внешние статические библиотеки зависимостей. Библиотеки, определённые в `LOCAL_LIBS` при значении 3 будут добавляться.
`LOCAL_BUILD_STATIC`: [0|1] - собирать ли статическую библиотеку, по умолчанию 1
`LOCAL_MODULES_PATHS`: набор путей к файлам для загрузки модулей (пути к файлам mk)
`LOCAL_MODULES`: список модулей, использумых в проекте.
`LOCAL_ROOT`: путь к корню текущего проекта. Чаще всего `LOCAL_ROOT = .`. От корня проекта вычисляется положение исходных файлов, включений и результатов.
`LOCAL_SRCS_DIRS`: Список директорий для **рекурсивного** обхода при компиляции. Все файлы *.c, *.cpp и *.mm (если возможно) в них будут скомпилированы. Файлы *.cc игнорируются как включения для SCU (Single compilation unit).
`LOCAL_SRCS_OBJS`: Список отдельных файлов для компиляции
`LOCAL_INCLUDES_DIRS`: Список директорий для **рекурсивного** поиска включений
`LOCAL_INCLUDES_OBJS`: Список отдельных директорий для поиска включений
`LOCAL_MAIN`: Путь к файлу, содержащему функцию main для сборки исполняемых приложений. Этот файл будет проигнорирован при сборке библиотек.
`LOCAL_LIBS`: список дополнительных статических библиотек для сборки проекта. Указывается полный путь до файла библиотеки (используйте `$(realpath)`)
`LOCAL_CFLAGS`: дополнительные флаги для C/C++
`LOCAL_CXXFLAGS`: дополнительные флаги только для C++
`LOCAL_LDFLAGS`: дополнительные флаги только для C++
`LOCAL_INSTALL_DIR`: целевая директория для установки
`LOCAL_FORCE_INSTALL`: если установлена в 1 - вызывать цель для установки после каждой сборки

`LOCAL_ANDROID_TARGET`: название цели для Android NDK, определённой во внешнем файле Android.mk. Собственный Android.mk не содержит правил для сборки приложения, только для сборки промежуточных элементов, потому необходимо указать конкретную цель в другом файле (по умолчанию, `application`). Используется только при прямом вызове NDK.
`LOCAL_ANDROID_PLATFORM`: целевая версия платформы Android (по умолчанию, `android-24`). Используется только при прямом вызове NDK.
`LOCAL_ANDROID_MK`: путь к внешнему файлу Android.mk уровня приложения. Этот файл должен экспортированный включать `Android.mk` проекта через `$(call import-module,stappler-build/android)`. Используется только при прямом вызове NDK.
`LOCAL_APPLICATION_MK`: путь к внешнему файлу Application.mk. Используется только при прямом вызове NDK.

`LOCAL_SHADERS_DIR`: список путей для шейдеров GLSL, для компиляции их в SPIR-V. Читаются шейдеры, находящиеся либо непосредственно внутри директории, либо в форме `*/<shadername>.<ext>/<target>.<ext>`. В последнем случае создаётся шейдер `<shadername>.<ext>` с несколькими точками входа на основе `<target>`. Шейдеры компилируются в форму заголовочного файла для включения в виде `<shadername>.<ext>.h`.

## Прочие

`STAPPLER_ROOT`: Путь к библиотеке libstappler-common, содержащей систему сборки
`STAPPLER_VERSION_PREFIX`: Защитный префикс для версионирования. Позволяет избежать дубликатов при линковке двух разных библиотек на основе SDK.
`STAPPLER_DO_NOT_ASSAMBLE_DEPS`: Не собирать библиотечные зависимости в конечный пакет (для разделяемых библиотек). В этом случае за включение библиотек отвечает приложение, подключающее библиотеку, либо `LOCAL_LIBS`. 

`ANDROID_NDK_ROOT`: Путь к Android NDK для сборки исходных файлов
`NDK`: Альтернатива `ANDROID_NDK_ROOT`

`VULKAN_SDK_PREFIX` - Путь к Vulkan SDK при компиляции Vulkan
`GLSLC` - Компилятор шейдеров, по умолчанию `$(VULKAN_SDK_PREFIX)/bin/glslangValidator`
`SPIRV_LINK` - Линковщик шейдеров, по умолчанию `$(VULKAN_SDK_PREFIX)/bin/spirv-link`

## Условные значения

Система использует двухпроходную технику, позволяя устанавливать параметры компиляции в исходном `Makefile` в зависимости от целевой системы. Переменные для проверки:

`LINUX`
`ANDROID`
`MACOS`
`WIN32` - Windows в любых вариантах
`MSYS` - Windows в варианте MSYS
`XWIN` - Windows при кросс-компиляции через XWin